<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Pulse</title>
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0a2233">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <style>
    :root{
      --bg:#071721;
      --panel:#0e2a3b;
      --panel-2:#113247;
      --text:#e9f6ff;
      --muted:#9ec7da;
      --accent:#58b7ff;
      --good:#5bd3a0;
      --warn:#ffd166;
      --bad:#ff6b6b;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:-apple-system, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif}
    header{position:sticky;top:0;background:linear-gradient(180deg, rgba(7,23,33,.95), rgba(7,23,33,.6));backdrop-filter:saturate(140%) blur(10px);z-index:10;border-bottom:1px solid #0f3346}
    header .row{display:flex;align-items:center;justify-content:space-between;padding:12px 16px}
    .title{font-weight:600;letter-spacing:.3px}
    .container{padding:16px; max-width:900px; margin:0 auto;}
    .ring{width:160px;height:160px;border-radius:50%;background:
      conic-gradient(var(--accent) calc(var(--pct)*1%), #1a4055 0);
      display:grid;place-items:center;margin:12px auto 8px;position:relative}
    .ring::after{content:"";position:absolute;inset:10px;border-radius:50%;background:var(--panel)}
    .ring .val{position:relative;font-size:28px;font-weight:700}
    .chips{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin:12px 0 16px}
    .chip{background:var(--panel-2);border:1px solid #214c65;padding:10px 14px;border-radius:999px;font-weight:600}
    .grid{display:grid;gap:12px;grid-template-columns:repeat(2,1fr)}
    @media (max-width:700px){.grid{grid-template-columns:1fr}}
    section{background:var(--panel);border:1px solid #133a52;border-radius:14px;padding:12px 12px 6px}
    h2{font-size:16px;margin:4px 0 10px;color:var(--muted);font-weight:600}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    button, input, select{font:inherit;color:var(--text)}
    button{background:var(--panel-2);border:1px solid #1c4258;border-radius:12px;padding:10px 12px;font-weight:600}
    button.primary{background:var(--accent);color:#05141b;border-color:#51a7ea}
    label{font-size:13px;color:var(--muted)}
    input[type="number"], input[type="text"]{background:#0b2330;border:1px solid #143a4f;border-radius:10px;padding:10px;width:100%}
    .pillbar{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin:10px 0 14px}
    .pill{padding:12px 16px;border-radius:999px;background:var(--panel-2);border:1px solid #214c65;font-weight:700}
    .success{color:var(--good)} .warn{color:var(--warn)} .bad{color:var(--bad)}
    .tiny{font-size:12px;color:var(--muted)}
    .footer{padding:20px 0;color:var(--muted);text-align:center}
    .hidden{display:none !important}
    .center{display:grid;place-items:center}
    .badge{padding:6px 10px;border-radius:999px;border:1px solid #214c65;background:#0f2f41;font-size:12px}
  </style>
</head>
<body>
<header>
  <div class="row">
    <div class="title">Pulse</div>
    <div class="row">
      <button id="btn-export">Export CSV</button>
      <button id="btn-print">Weekly PDF</button>
      <button id="btn-shield" class="primary">Stress Shield</button>
    </div>
  </div>
</header>

<div class="container">
  <div class="center">
    <div class="ring" id="scoreRing" style="--pct:0">
      <div class="val" id="scoreVal">0</div>
    </div>
    <div class="tiny" id="scoreBreakdown"></div>
  </div>

  <div class="pillbar">
    <button class="pill" data-open="log-meal">+ Meal</button>
    <button class="pill" data-open="log-activity">+ Workout</button>
    <button class="pill" data-open="log-sleep">+ Sleep</button>
    <button class="pill" data-open="log-habit">+ Habit</button>
    <button class="pill" id="start-fast">⏳ Fast</button>
    <button class="pill" id="log-water">+ Water</button>
  </div>

  <div class="grid">
    <section id="today">
      <h2>Today</h2>
      <div id="todayList" class="tiny">No entries yet.</div>
    </section>

    <section id="quests">
      <h2>Quests & Streaks</h2>
      <div class="row">
        <div class="badge">Streaks: <span id="streakDays">0</span> days</div>
        <div class="badge">Rest tokens: <span id="restTokens">0</span></div>
      </div>
      <div style="margin-top:8px" class="tiny">Active Quest: <span id="activeQuest">No-Junk Week (0/7)</span></div>
    </section>

    <section id="stressShield">
      <h2>Stress Shield</h2>
      <div class="row">
        <button onclick="Shield.startBreath()">60s Breathing</button>
        <button onclick="Shield.startUrgeSurf()">10m Urge Surf</button>
        <button onclick="Shield.grounding()">5-4-3-2-1</button>
      </div>
      <div id="shieldUI" class="tiny" style="margin-top:8px"></div>
    </section>

    <section id="log-meal" class="hidden">
      <h2>Log Meal</h2>
      <div class="row">
        <button onclick="Log.mealPreset('Breakfast')">Breakfast</button>
        <button onclick="Log.mealPreset('Lunch')">Lunch</button>
        <button onclick="Log.mealPreset('Dinner')">Dinner</button>
        <button onclick="Log.mealPreset('Snack')">Snack</button>
      </div>
      <div style="margin-top:8px">
        <label>Notes (or type “something else”)</label>
        <input id="meal-notes" type="text" placeholder="e.g., salmon bowl, apple; or something else">
      </div>
      <div class="row" style="margin-top:8px">
        <div style="flex:1"><label>Calories (opt)</label><input id="meal-cal" type="number" inputmode="numeric"></div>
        <div style="flex:1"><label>Protein g (opt)</label><input id="meal-pro" type="number" inputmode="numeric"></div>
      </div>
      <div class="row" style="margin-top:8px">
        <button class="primary" onclick="Log.saveMeal()">Save</button>
        <button onclick="UI.close('log-meal')">Close</button>
      </div>
    </section>

    <section id="log-activity" class="hidden">
      <h2>Log Workout</h2>
      <div class="row">
        <select id="act-type">
          <option>Walk</option><option>Run</option><option>Swim</option><option>Bike</option><option>Strength</option><option>Yoga</option>
        </select>
        <input id="act-min" type="number" inputmode="numeric" placeholder="min">
        <input id="act-rpe" type="number" inputmode="numeric" placeholder="RPE (1-10)">
      </div>
      <div class="row" style="margin-top:8px">
        <button class="primary" onclick="Log.saveActivity()">Save</button>
        <button onclick="UI.close('log-activity')">Close</button>
      </div>
    </section>

    <section id="log-sleep" class="hidden">
      <h2>Log Sleep</h2>
      <div class="row">
        <input id="sleep-start" type="datetime-local">
        <input id="sleep-end" type="datetime-local">
        <select id="sleep-quality">
          <option value="3">OK</option><option value="4">Good</option><option value="5">Great</option><option value="2">Poor</option><option value="1">Bad</option>
        </select>
      </div>
      <div class="row" style="margin-top:8px">
        <button class="primary" onclick="Log.saveSleep()">Save</button>
        <button onclick="UI.close('log-sleep')">Close</button>
      </div>
    </section>

    <section id="log-habit" class="hidden">
      <h2>Log Habit</h2>
      <div class="row">
        <select id="habit-type">
          <option>No Alcohol</option>
          <option>No Junk/Chips</option>
          <option>Mobility 10 min</option>
          <option>Hydration Goal</option>
          <option>Skincare</option>
          <option>Custom</option>
        </select>
        <input id="habit-notes" type="text" placeholder="optional note">
      </div>
      <div class="row" style="margin-top:8px">
        <button class="primary" onclick="Log.saveHabit()">Save</button>
        <button onclick="UI.close('log-habit')">Close</button>
      </div>
    </section>
  </div>

  <div class="footer tiny">Local-first • FaceID lock in Settings (coming next) • v1</div>
</div>

<script>
// --- PWA SW ---
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js'));
}

// --- Simple local store (IndexedDB via minimal wrapper) ---
const DB = (()=>{
  const DB_NAME = 'pulse-db', STORE='kv';
  let dbp;
  function withStore(type, cb){
    return (dbp || (dbp = new Promise((res, rej)=>{
      const open = indexedDB.open(DB_NAME, 1);
      open.onupgradeneeded = ()=> open.result.createObjectStore(STORE);
      open.onsuccess = ()=> res(open.result);
      open.onerror = ()=> rej(open.error);
    }))).then(db=> new Promise((res, rej)=>{
      const tx = db.transaction(STORE, type);
      const store = tx.objectStore(STORE);
      cb(store);
      tx.oncomplete = ()=> res();
      tx.onerror = ()=> rej(tx.error);
    }));
  }
  return {
    async get(key){ return new Promise((res, rej)=> withStore('readonly', store=>{
      const req = store.get(key); req.onsuccess = ()=> res(req.result); req.onerror = ()=> rej(req.error);
    }));},
    async set(key, val){ return withStore('readwrite', store=> store.put(val, key)); },
    async del(key){ return withStore('readwrite', store=> store.delete(key)); },
    async keys(){ return new Promise((res, rej)=> withStore('readonly', store=>{
      const ks=[]; const cur = store.openCursor();
      cur.onsuccess = ()=>{ const c=cur.result; if(c){ ks.push(c.key); c.continue(); } else res(ks); };
      cur.onerror = ()=> rej(cur.error);
    }));}
  }
})();

const dayKey = (d=new Date()) => d.toISOString().slice(0,10);
const state = {
  goals: { kcal: null, protein: null, weeklyMinutes: 150, workoutsPerWeek: 3, sleepHours: 7, water: 2000 },
  habits: ["No Alcohol","No Junk/Chips","Mobility 10 min","Hydration Goal","Skincare"],
  restTokens: 0,
  streakDays: 0,
  fasting: { active:false, startedAt:null },
  quest: { name:"No-Junk Week", progress:0, target:7 }
};

async function load(){
  const saved = await DB.get('state');
  if(saved) Object.assign(state, saved);
  UI.render();
  Import.handleDeepLink();
}
load();

function save(){ DB.set('state', state); }

// --- Logging ---
const Log = {
  mealPreset(type){ document.getElementById('meal-notes').value = type; },
  async saveMeal(){
    const notes = document.getElementById('meal-notes').value.trim();
    const cal = +document.getElementById('meal-cal').value || null;
    const pro = +document.getElementById('meal-pro').value || null;
    const entry = { kind:'meal', ts: Date.now(), notes, cal, pro };
    await addEntry(entry);
    UI.close('log-meal');
  },
  async saveActivity(){
    const type = document.getElementById('act-type').value;
    const min = +document.getElementById('act-min').value || 0;
    const rpe = +document.getElementById('act-rpe').value || null;
    const entry = { kind:'activity', ts: Date.now(), type, min, rpe };
    await addEntry(entry);
    UI.close('log-activity');
  },
  async saveSleep(){
    const start = new Date(document.getElementById('sleep-start').value).getTime();
    const end = new Date(document.getElementById('sleep-end').value).getTime();
    const q = +document.getElementById('sleep-quality').value;
    if(!start || !end || end <= start){ alert('Please set valid start/end'); return; }
    const entry = { kind:'sleep', ts: Date.now(), start, end, q };
    await addEntry(entry);
    UI.close('log-sleep');
  },
  async saveHabit(){
    const type = document.getElementById('habit-type').value;
    const notes = document.getElementById('habit-notes').value.trim();
    const entry = { kind:'habit', ts: Date.now(), type, notes };
    await addEntry(entry);
    UI.close('log-habit');
  }
};

async function addEntry(entry){
  const day = dayKey();
  const k = 'day:'+day;
  const dayData = (await DB.get(k)) || { entries:[] };
  dayData.entries.push(entry);
  await DB.set(k, dayData);
  if(entry.kind==='habit'){
    if(entry.type==='No Junk/Chips'){
      // increment quest if marked as achieved (no junk logged as success)
      state.quest.progress = Math.min(state.quest.target, state.quest.progress + 1);
    }
  }
  save();
  UI.render();
}

// --- Score calculation ---
async function calcScore(){
  const day = dayKey();
  const dayData = (await DB.get('day:'+day)) || { entries:[] };
  let fuel=0, move=0, recover=0, habits=0;
  // Fuel: partial for any meals logged + optional calories/protein presence
  const meals = dayData.entries.filter(e=>e.kind==='meal');
  if(meals.length>0) fuel += 10;
  if(meals.some(m=>m.pro)) fuel += 10;
  if(state.fasting.active===false && state.fasting.last && (Date.now()-state.fasting.last)>0) fuel +=5;
  fuel = Math.min(25, fuel);

  // Move: minutes logged vs 30 min target/day proxy
  const mins = dayData.entries.filter(e=>e.kind==='activity').reduce((a,b)=>a+(b.min||0),0);
  move = Math.min(25, Math.round((mins/30)*25));

  // Recover: sleep hours vs goal
  const sleep = dayData.entries.find(e=>e.kind==='sleep');
  if(sleep){
    const h = (sleep.end - sleep.start)/3600000;
    recover = Math.min(25, Math.round((h / state.goals.sleepHours)*25));
  }

  // Habits: count completed habits today
  const hb = dayData.entries.filter(e=>e.kind==='habit').map(e=>e.type);
  const unique = new Set(hb);
  habits = Math.min(25, Math.round((unique.size / Math.max(1,state.habits.length))*25));

  const total = fuel+move+recover+habits;
  return { total, fuel, move, recover, habits, entries: dayData.entries };
}

// --- UI ---
const UI = {
  async render(){
    const {total,fuel,move,recover,habits,entries} = await calcScore();
    const pct = Math.round((total/100)*100);
    const ring = document.getElementById('scoreRing');
    const val = document.getElementById('scoreVal');
    ring.style.setProperty('--pct', pct);
    val.textContent = total;
    document.getElementById('scoreBreakdown').textContent = `Fuel ${fuel} • Move ${move} • Recover ${recover} • Habits ${habits}`;
    const list = document.getElementById('todayList');
    if(entries.length===0){ list.textContent = 'No entries yet.'; }
    else{
      list.innerHTML = entries.slice().reverse().map(e=>{
        const t = new Date(e.ts).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        if(e.kind==='meal') return `<div>🍽️ ${t}: ${e.notes || 'Meal'} ${e.cal?('· '+e.cal+' kcal'):''}</div>`;
        if(e.kind==='activity') return `<div>🏃 ${t}: ${e.type} · ${e.min||0} min ${e.rpe?('· RPE '+e.rpe):''}</div>`;
        if(e.kind==='sleep') return `<div>😴 ${t}: Sleep ${((e.end-e.start)/3600000).toFixed(1)} h · Q${e.q}</div>`;
        if(e.kind==='habit') return `<div>✅ ${t}: ${e.type}${e.notes?(' · '+e.notes):''}</div>`;
        return `<div>• ${t}</div>`;
      }).join('');
    }
    document.getElementById('streakDays').textContent = state.streakDays;
    document.getElementById('restTokens').textContent = state.restTokens;
    document.getElementById('activeQuest').textContent = `${state.quest.name} (${state.quest.progress}/${state.quest.target})`;
  },
  close(id){ document.getElementById(id).classList.add('hidden'); },
  open(id){ document.getElementById(id).classList.remove('hidden'); }
};
document.querySelectorAll('[data-open]').forEach(b=> b.addEventListener('click', ()=> UI.open(b.dataset.open)));

// Water quick add
document.getElementById('log-water').addEventListener('click', async ()=>{
  await addEntry({kind:'habit', ts: Date.now(), type:'Hydration Goal', notes:'water+’});
});

// Fasting
document.getElementById('start-fast').addEventListener('click', ()=>{
  if(!state.fasting.active){
    state.fasting.active=true; state.fasting.startedAt=Date.now(); save();
    alert('Fasting started');
  }else{
    state.fasting.active=false; state.fasting.last=Date.now(); save();
    alert('Fasting ended');
  }
  UI.render();
});

// Export CSV
document.getElementById('btn-export').addEventListener('click', async ()=>{
  const keys = await DB.keys();
  const dayKeys = keys.filter(k=>k.startsWith('day:')).sort();
  const rows = [["date","kind","time","fields"]];
  for(const k of dayKeys){
    const d = k.slice(4);
    const day = await DB.get(k);
    for(const e of day.entries){
      const time = new Date(e.ts).toISOString();
      const fields = JSON.stringify(e);
      rows.push([d, e.kind, time, fields]);
    }
  }
  const csv = rows.map(r=>r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(",")).join("\n");
  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='pulse-export.csv'; a.click();
  URL.revokeObjectURL(url);
});

// Weekly PDF (uses print CSS via window.print)
document.getElementById('btn-print').addEventListener('click', ()=> window.print());

// Stress Shield
const Shield = {
  _timer:null,
  startBreath(){
    const el = document.getElementById('shieldUI');
    let secs=60, phase=0, phases=[4,4,4,4]; // box breathing
    el.innerHTML = 'Breathing…';
    clearInterval(this._timer);
    this._timer = setInterval(()=>{
      if(secs<=0){ clearInterval(this._timer); el.textContent='Done. Nice reset.'; return; }
      const p = phases[phase%4];
      const mode = ['Inhale','Hold','Exhale','Hold'][phase%4];
      el.innerHTML = `<div><strong>${mode}</strong> · ${p}s &nbsp;&nbsp; <span class="tiny">${secs}s left</span></div>`;
      phase++; secs -= p;
    }, 1000);
  },
  startUrgeSurf(){
    const el = document.getElementById('shieldUI');
    let secs=600, score=0;
    el.innerHTML = '<div>Urge Surf 10:00 · Tap the bubbles to stay present.</div><div id="game"></div>';
    const game = document.getElementById('game');
    game.style.minHeight='120px';
    game.onclick = ()=>{ score++; el.querySelector('#game').innerHTML = `<div class="tiny">Taps: ${score}</div>`; };
    clearInterval(this._timer);
    this._timer = setInterval(()=>{
      secs--; if(secs<=0){ clearInterval(this._timer); el.innerHTML = `Craving passed. You earned a small win badge. Taps: ${score}`; }
      else el.firstChild.textContent = `Urge Surf ${String(Math.floor(secs/60)).padStart(2,'0')}:${String(secs%60).padStart(2,'0')} · Tap the bubbles to stay present.`;
    }, 1000);
  },
  grounding(){
    const prompts = [
      "Name 5 things you can see.",
      "Name 4 things you can feel.",
      "Name 3 things you can hear.",
      "Name 2 things you can smell.",
      "Name 1 thing you can taste or are grateful for."
    ];
    const el = document.getElementById('shieldUI');
    el.innerHTML = prompts.map((p,i)=>`<div>${i+1}. ${p}</div>`).join('');
  }
};

// Import via URL for Shortcuts: #import?steps=5000&type=steps&date=YYYY-MM-DD
const Import = {
  async handleDeepLink(){
    const hash = location.hash || "";
    if(!hash.startsWith('#import')) return;
    const qs = new URLSearchParams(hash.split('?')[1]||"");
    const type = qs.get('type');
    if(type==='steps'){
      const steps = parseInt(qs.get('steps')||'0',10);
      const entry = { kind:'activity', ts: Date.now(), type:'Steps', min: Math.round(steps/100), rpe:null, steps };
      await addEntry(entry);
      alert(`Imported ${steps} steps.`);
      history.replaceState(null, '', location.pathname);
    }
  }
};

// Simple modal opens
document.getElementById('btn-shield').addEventListener('click', ()=>{
  document.getElementById('stressShield').scrollIntoView({behavior:'smooth', block:'center'});
  Shield.startBreath();
});
</script>
</body>
</html>

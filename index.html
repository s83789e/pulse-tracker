<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Pulse</title>
  <link rel="manifest" href="manifest.webmanifest?v=43">
  <meta name="theme-color" content="#0b1520">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <style>
    :root{
      --bg: #f7f7f5; --card: rgba(255,255,255,.9); --text: #0f172a; --muted:#64748b; --line:#e2e8f0; 
      --accent:#2563eb; --good:#10b981; --warn:#f59e0b; --bad:#ef4444; --shadow:0 10px 30px rgba(0,0,0,.08);
      --panel:#ffffff;
      --sea1:#8fe8ff; --sea2:#28b7e1; --sea3:#0e7aa5;
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg:#0b1520; --card: rgba(18,31,48,.9); --text:#eaf2f8; --muted:#a9c3d6; --line:#183044;
        --accent:#58b7ff; --shadow:0 10px 30px rgba(0,0,0,.35); --panel:#0f2233;
      }
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg),var(--bg));color:var(--text);font-family:-apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    header{position:sticky;top:0;background:linear-gradient(180deg, rgba(11,21,32,.9), rgba(11,21,32,.65));backdrop-filter:saturate(140%) blur(10px);z-index:10;border-bottom:1px solid var(--line)}
    header .row{display:flex;align-items:center;justify-content:space-between;padding:12px 16px}
    .title{font-weight:800;letter-spacing:.3px}
    .app{padding:16px;max-width:480px;margin:0 auto}
    .tabs{display:flex;gap:8px;margin:12px 0}
    .tab{flex:1;padding:12px;border-radius:12px;background:var(--card);border:1.5px solid var(--line);text-align:center;font-weight:700;box-shadow:var(--shadow)}
    .tab.active{outline:2px solid var(--accent)}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:14px;box-shadow:var(--shadow);margin:12px 0}
    h2{font-size:15px;margin:2px 0 10px;color:var(--muted);font-weight:800;letter-spacing:.2px}
    .ring{width:180px;height:180px;border-radius:50%;display:grid;place-items:center;margin:8px auto 6px;position:relative;background:conic-gradient(var(--accent) calc(var(--pct)*1%), rgba(0,0,0,.08) 0)}
    .ring:after{content:"";position:absolute;inset:12px;border-radius:50%;background:var(--panel)}
    .ring .val{position:relative;font-size:34px;font-weight:800}
    .pillbar{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin:12px 0}
    .pill{padding:12px 16px;border-radius:999px;background:transparent;border:1.5px solid var(--accent);color:var(--accent);font-weight:800}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    input, select, button{font:inherit;color:var(--text)}
    .input{background:transparent;border:1.8px solid var(--line);border-radius:12px;padding:12px;width:100%}
    select.input{appearance:none;background-image:linear-gradient(45deg, transparent 50%, var(--muted) 50%), linear-gradient(135deg, var(--muted) 50%, transparent 50%);background-position:calc(100% - 16px) calc(1em + 2px), calc(100% - 11px) calc(1em + 2px);background-size:5px 5px,5px 5px;background-repeat:no-repeat;padding-right:32px}
    .btn{background:var(--accent);color:white;border:none;border-radius:12px;padding:12px 14px;font-weight:800;box-shadow:var(--shadow)}
    .btn.ghost{background:transparent;color:var(--accent);border:1.8px solid var(--accent)}
    .tiny{font-size:12px;color:var(--muted)}
    .hidden{display:none !important}
    .footer{padding:18px 0;color:var(--muted);text-align:center}
    /* Stress Shield Dive Mode */
    .diveCard{position:relative;border-radius:16px;overflow:hidden;border:1px solid var(--line);}
    .diveSea{position:relative;height:360px;background:radial-gradient(80% 60% at 50% 0%, var(--sea1) 0%, var(--sea2) 40%, var(--sea3) 85%);}
    .rays{position:absolute;inset:-20% -20% 0 -20%;background:
      repeating-linear-gradient(115deg, rgba(255,255,255,.18) 0 2px, rgba(255,255,255,0) 2px 28px);
      mix-blend-mode:overlay;opacity:.35; animation:rays 12s linear infinite;}
    @keyframes rays{ from{transform:translateY(-20px) rotate(0deg)} to{transform:translateY(20px) rotate(1deg)} }
    .depth{position:absolute;left:8px;top:8px;background:rgba(0,0,0,.25);padding:6px 8px;border-radius:10px;border:1px solid rgba(255,255,255,.35);color:#fff;font-weight:700}
    .progress{position:absolute;right:8px;top:8px;width:10px;height:320px;border-radius:999px;background:rgba(255,255,255,.18);overflow:hidden;border:1px solid rgba(255,255,255,.35)}
    .progress .bar{position:absolute;bottom:0;width:100%;height:0;background:linear-gradient(#58b7ff,#9fe1ff)}
    .diver{position:absolute;left:50%;transform:translateX(-50%);width:42px;height:42px;border-radius:10px;background:#55c6ff;border:2px solid #00384f;display:grid;place-items:center;box-shadow:0 6px 18px rgba(0,0,0,.4)}
    .diver:after{content:"ü§ø";font-size:24px}
    .fish{position:absolute;top:50%;left:-60px;width:44px;height:24px;background:#ffb347;border-radius:12px 8px 8px 12px;box-shadow:0 2px 8px rgba(0,0,0,.35);display:grid;place-items:center;transition:transform .2s}
    .fish::after{content:"üêü";font-size:20px}
    .fish.photographed{background:transparent;border:2px solid #fff; width:54px;height:34px;border-radius:6px;box-shadow:0 0 0 2px rgba(0,0,0,.2) inset}
    .bubbles{position:absolute;inset:0;pointer-events:none}
    .bubble{position:absolute;bottom:-20px;width:8px;height:8px;background:rgba(255,255,255,.3);border-radius:50%;animation:rise 6s linear infinite}
    @keyframes rise{0%{transform:translateY(0) scale(1)}100%{transform:translateY(-400px) scale(1.2)}}
    .hud{display:flex;align-items:center;justify-content:space-between;margin:8px 0 4px}
    /* Games grid */
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    .game{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px}
    .game h3{margin:4px 0 8px;font-size:15px;color:var(--muted)}
    /* Bubble burst */
    .popsea{position:relative;height:220px;border-radius:12px;background:linear-gradient(#0a2f44,#0a2331);overflow:hidden;border:1px solid #174d67}
    .pop{position:absolute;bottom:-30px;width:18px;height:18px;border-radius:50%;background:rgba(255,255,255,.35);animation:float 7s linear forwards}
    @keyframes float{to{transform:translateY(-260px)}}
    /* Name 3 Fish */
    .chips{display:flex;gap:10px;flex-wrap:wrap}
    .chip{padding:8px 12px;border-radius:999px;background:#14354a;border:1px solid #275b79;cursor:pointer;color:#eaf2f8}
    .chip.correct{background:#0f3f2e;border-color:#1b7a56}
    .chip.wrong{background:#402222;border-color:#7a3131}
    /* Quiz */
    .quiz .q{margin:8px 0}
    .quiz .opt{padding:8px 10px;border:1px solid #275b79;border-radius:10px;margin:6px 0;cursor:pointer}
    .opt.good{background:#0f3f2e;border-color:#1b7a56}
    .opt.bad{background:#402222;border-color:#7a3131}
    /* Hidden marine life */
    .hidden-scene{position:relative;height:220px;border-radius:12px;background:linear-gradient(#092638,#0e2f43);overflow:hidden;border:1px solid #174d67}
    .rock{position:absolute;background:#0b1e2b;border-radius:50%}
    .camouflage{position:absolute;border-radius:50%;background:#0c2130;opacity:.9;transition:opacity .2s}
    .camouflage.found{opacity:.2;outline:2px solid #5bd3a0}
  </style>
</head>
<body>
<header>
  <div class="row">
    <div class="title">Pulse</div>
    <div class="row">
      <button id="btn-export" class="btn ghost">Export CSV</button>
      <button id="btn-print" class="btn ghost">Weekly PDF</button>
      <button id="btn-shield" class="btn">Stress Shield</button>
    </div>
  </div>
</header>

<div class="app">
  <div class="tabs">
    <div class="tab active" onclick="show('home')">Home</div>
    <div class="tab" onclick="show('meal')">Log Meal</div>
    <div class="tab" onclick="show('shield')">Stress Shield</div>
    <div class="tab" onclick="show('habits')">Habits</div>
  </div>

  <!-- HOME -->
  <div id="home" class="screen">
    <div class="card center">
      <div class="ring" id="scoreRing" style="--pct:0"><div class="val" id="scoreVal">0</div></div>
      <div class="tiny" id="scoreBreakdown"></div>
      <div class="pillbar">
        <button class="pill" onclick="show('meal')">+ Meal</button>
        <button class="pill" onclick="show('shield')">Stress Reset</button>
        <button class="pill" onclick="show('habits')">+ Habit</button>
      </div>
    </div>
    <div class="card">
      <h2>Quests & Streaks</h2>
      <div class="row">
        <div class="badge">Streak: <span id="streakDays">0</span> days</div>
        <div class="badge">Rest tokens: <span id="restTokens">0</span></div>
        <div class="badge" id="questBadge">No-Junk Week 0/7</div>
      </div>
    </div>
    <div class="card">
      <h2>Today</h2>
      <div id="todayList" class="tiny">No entries yet.</div>
    </div>
  </div>

  <!-- MEAL -->
  <div id="meal" class="screen hidden">
    <div class="card">
      <h2>Quick Log</h2>
      <div class="row">
        <button class="pill" onclick="Log.mealPreset('Breakfast')">Breakfast</button>
        <button class="pill" onclick="Log.mealPreset('Lunch')">Lunch</button>
        <button class="pill" onclick="Log.mealPreset('Dinner')">Dinner</button>
        <button class="pill" onclick="Log.mealPreset('Snack')">Snack</button>
      </div>
    </div>
    <div class="card">
      <h2>Photo or Text</h2>
      <div class="row">
        <input id="meal-photo" class="input" type="file" accept="image/*">
      </div>
      <div class="row" style="margin-top:10px">
        <input id="meal-text" class="input" type="text" placeholder="e.g., 2 eggs, toast, avocado">
        <button class="btn" onclick="estimateMeal()">Estimate ‚Üí</button>
      </div>
      <div class="tiny" id="est-out" style="margin-top:8px"></div>
      <div class="row" style="margin-top:10px">
        <input id="meal-cal" class="input" type="number" inputmode="numeric" placeholder="Adjust calories (optional)">
        <input id="meal-pro" class="input" type="number" inputmode="numeric" placeholder="Protein g (optional)">
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn" onclick="Log.saveMeal()">Save</button>
        <button class="btn ghost" onclick="show('home')">Close</button>
      </div>
      <div class="tiny" style="margin-top:8px">Photo calories need a tiny backend (coming next). Text estimates work now.</div>
    </div>
  </div>

  <!-- STRESS SHIELD: Dive Mode -->
  <div id="shield" class="screen hidden">
    <div class="card diveCard">
      <div class="diveSea" id="dive">
        <div class="rays"></div>
        <div class="depth" id="depth">Depth: 10 m</div>
        <div class="progress"><div class="bar" id="ascBar"></div></div>
        <div class="diver" id="diver" style="top:300px"></div>
        <div class="bubbles" id="bubbles"></div>
        <div id="fishLayer"></div>
      </div>
      <div class="hud">
        <div class="tiny" id="timerLabel">Ready ‚Ä¢ 10:00</div>
        <div class="tiny">Photos: <span id="photos">0</span></div>
      </div>
      <div class="row" style="margin-bottom:8px">
        <button class="btn" onclick="startDive(600)">Start 10:00</button>
        <button class="btn ghost" onclick="startDive(60)">Demo 1:00</button>
        <button class="btn ghost" onclick="stopDive()">Stop</button>
      </div>
    </div>

    <div class="grid">
      <div class="game">
        <h3>Bubble Burst</h3>
        <div class="row">
          <button class="btn" onclick="startBubbles()">Start</button>
          <button class="btn ghost" onclick="stopBubbles()">Stop</button>
          <div class="tiny">Score: <span id="bubbleScore">0</span></div>
        </div>
        <div class="popsea" id="popsea"></div>
      </div>

      <div class="game">
        <h3>Name 3 Fish</h3>
        <div class="tiny">Pick any 3 correct names for the fish you see:</div>
        <div class="chips" id="fishChips"></div>
        <div class="tiny" id="nameStatus">0 / 3</div>
      </div>

      <div class="game quiz">
        <h3>Diving & Marine Quiz</h3>
        <div class="q" id="quizQ">At what depth is a 3-minute safety stop usually performed?</div>
        <div id="quizOpts"></div>
        <div class="tiny" id="quizMsg"></div>
      </div>

      <div class="game">
        <h3>Spot Hidden Marine Life</h3>
        <div class="tiny">Find the camouflaged animals in the reef.</div>
        <div class="hidden-scene" id="scene"></div>
        <div class="tiny">Found: <span id="foundCount">0</span> / 3</div>
      </div>
    </div>
  </div>

  <!-- HABITS -->
  <div id="habits" class="screen hidden">
    <div class="card">
      <h2>Log Habit</h2>
      <div class="row">
        <select id="habit-type" class="input">
          <option>No Alcohol</option>
          <option>No Junk/Chips</option>
          <option>Mobility 10 min</option>
          <option>Hydration Goal</option>
          <option>Skincare</option>
          <option>Custom</option>
        </select>
        <input id="habit-notes" class="input" type="text" placeholder="note (optional)">
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn" onclick="Log.saveHabit()">Save</button>
        <button class="btn ghost" onclick="show('home')">Close</button>
      </div>
    </div>
  </div>

  <div class="footer tiny">Local-first ‚Ä¢ v4.3</div>
</div>

<script>
// PWA SW
if('serviceWorker' in navigator){ window.addEventListener('load', ()=> navigator.serviceWorker.register('./sw.js')); }

// DB
const DB = (()=>{
  const DB_NAME='pulse-db', STORE='kv'; let dbp;
  function withStore(type, cb){
    return (dbp || (dbp = new Promise((res, rej)=>{
      const open = indexedDB.open(DB_NAME, 1);
      open.onupgradeneeded = ()=> open.result.createObjectStore(STORE);
      open.onsuccess = ()=> res(open.result);
      open.onerror = ()=> rej(open.error);
    }))).then(db=> new Promise((res, rej)=>{
      const tx = db.transaction(STORE, type); const store = tx.objectStore(STORE);
      cb(store); tx.oncomplete=()=>res(); tx.onerror=()=>rej(tx.error);
    }));
  }
  return {
    async get(k){ return new Promise((res,rej)=> withStore('readonly', s=>{ const r=s.get(k); r.onsuccess=()=>res(r.result); r.onerror=()=>rej(r.error);})); },
    async set(k,v){ return withStore('readwrite', s=> s.put(v,k)); },
    async keys(){ return new Promise((res,rej)=> withStore('readonly', s=>{ const ks=[]; const c=s.openCursor(); c.onsuccess=()=>{const cur=c.result; if(cur){ks.push(cur.key); cur.continue();} else res(ks);}; c.onerror=()=>rej(c.error);})); }
  }
})();

const dayKey = (d=new Date()) => d.toISOString().slice(0,10);
const state = {
  goals:{kcal:null,protein:null,weeklyMinutes:150,workoutsPerWeek:3,sleepHours:7,water:2000},
  habits:["No Alcohol","No Junk/Chips","Mobility 10 min","Hydration Goal","Skincare"],
  restTokens:0, streakDays:0,
  fasting:{active:false, startedAt:null, last:null},
  quest:{name:"No-Junk Week", progress:0, target:7}
};
async function load(){ const saved=await DB.get('state'); if(saved) Object.assign(state,saved); UI.render(); }
load();
function save(){ DB.set('state', state); }

// Logging helpers
const Log = {
  mealPreset(t){ document.getElementById('meal-text').value = t; },
  async saveMeal(){
    const notes = document.getElementById('meal-text').value.trim();
    const cal = +document.getElementById('meal-cal').value || null;
    const pro = +document.getElementById('meal-pro').value || null;
    await addEntry({kind:'meal', ts:Date.now(), notes, cal, pro});
    show('home');
  },
  async saveHabit(){
    const type = document.getElementById('habit-type').value;
    const notes = document.getElementById('habit-notes').value.trim();
    await addEntry({kind:'habit', ts:Date.now(), type, notes});
    show('home');
  }
};
async function addEntry(entry){
  const k='day:'+dayKey(); const dayData = (await DB.get(k)) || { entries:[] };
  dayData.entries.push(entry); await DB.set(k, dayData);
  if(entry.kind==='habit' && entry.type==='No Junk/Chips'){ state.quest.progress = Math.min(state.quest.target, state.quest.progress+1); }
  save(); UI.render();
}

// Scoring
async function calcScore(){
  const dayData = (await DB.get('day:'+dayKey())) || { entries:[] };
  let fuel=0, move=0, recover=0, habits=0;
  const meals = dayData.entries.filter(e=>e.kind==='meal');
  if(meals.length>0) fuel += 10;
  if(meals.some(m=>m.pro)) fuel += 10;
  if(!state.fasting.active && state.fasting.last) fuel +=5;
  fuel = Math.min(25, fuel);
  const mins = dayData.entries.filter(e=>e.kind==='activity').reduce((a,b)=>a+(b.min||0),0);
  move = Math.min(25, Math.round((mins/30)*25));
  const sleep = dayData.entries.find(e=>e.kind==='sleep');
  if(sleep){ const h=(sleep.end-sleep.start)/3600000; recover = Math.min(25, Math.round((h/state.goals.sleepHours)*25)); }
  const hb = dayData.entries.filter(e=>e.kind==='habit').map(e=>e.type);
  const unique = new Set(hb); habits = Math.min(25, Math.round((unique.size/Math.max(1,state.habits.length))*25));
  return { total:fuel+move+recover+habits, fuel, move, recover, habits, entries: dayData.entries };
}

// UI
const UI = {
  async render(){
    const {total,fuel,move,recover,habits,entries} = await calcScore();
    document.getElementById('scoreRing').style.setProperty('--pct', Math.round((total/100)*100));
    document.getElementById('scoreVal').textContent = total;
    document.getElementById('scoreBreakdown').textContent = `Fuel ${fuel} ‚Ä¢ Move ${move} ‚Ä¢ Recover ${recover} ‚Ä¢ Habits ${habits}`;
    const list = document.getElementById('todayList');
    list.innerHTML = entries.length? entries.slice().reverse().map(e=>{
      const t = new Date(e.ts).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
      if(e.kind==='meal') return `<div>üçΩÔ∏è ${t}: ${e.notes||'Meal'} ${e.cal?('¬∑ '+e.cal+' kcal'):''}</div>`;
      if(e.kind==='activity') return `<div>üèÉ ${t}: ${e.type||'Workout'} ¬∑ ${e.min||0} min ${e.rpe?('¬∑ RPE '+e.rpe):''}</div>`;
      if(e.kind==='sleep') return `<div>üò¥ ${t}: Sleep ${((e.end-e.start)/3600000).toFixed(1)} h</div>`;
      if(e.kind==='habit') return `<div>‚úÖ ${t}: ${e.type}${e.notes?(' ¬∑ '+e.notes):''}</div>`;
      return `<div>‚Ä¢ ${t}</div>`;
    }).join('') : 'No entries yet.';
    document.getElementById('streakDays').textContent = state.streakDays;
    document.getElementById('restTokens').textContent = state.restTokens;
    document.getElementById('questBadge').textContent = `${state.quest.name} ${state.quest.progress}/${state.quest.target}`;
  }
};
function show(id){
  document.querySelectorAll('.screen').forEach(s=> s.classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
  document.querySelectorAll('.tab').forEach(t=> t.classList.remove('active'));
  const idx = {home:0, meal:1, shield:2, habits:3}[id];
  document.querySelectorAll('.tab')[idx].classList.add('active');
}
document.getElementById('btn-export').addEventListener('click', async ()=>{
  const keys = await DB.keys(); const days = keys.filter(k=>k.startsWith('day:')).sort();
  const rows=[["date","kind","time","fields"]];
  for(const k of days){ const d=k.slice(4); const day=await DB.get(k); for(const e of day.entries){ rows.push([d,e.kind,new Date(e.ts).toISOString(), JSON.stringify(e)]); } }
  const csv = rows.map(r=> r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(",")).join("\\n");
  const blob = new Blob([csv], {type:'text/csv'}); const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='pulse-export.csv'; a.click(); URL.revokeObjectURL(url);
});
document.getElementById('btn-print').addEventListener('click', ()=> window.print());
document.getElementById('btn-shield').addEventListener('click', ()=>{ show('shield'); startDive(600); });

/* ----------------- DIVE MODE ----------------- */
let diveInt=null, diveSecs=0, diveTotal=600, photos=0, fishTimer=null;
function startDive(total){
  stopDive();
  diveTotal = total; diveSecs = total;
  photos = 0; document.getElementById('photos').textContent = photos;
  document.getElementById('timerLabel').textContent = "Starting‚Ä¶";
  const diver = document.getElementById('diver');
  const ascBar = document.getElementById('ascBar');
  const depthLabel = document.getElementById('depth');
  const dive = document.getElementById('dive');
  createFishLoop(); createBubbles();
  diveInt = setInterval(()=>{
    diveSecs--;
    const pct = 1 - (diveSecs / diveTotal);
    const depth = Math.max(0, Math.round((1-pct)*10));
    depthLabel.textContent = "Depth: " + depth + " m";
    ascBar.style.height = Math.round(pct*320) + "px";
    diver.style.top = (300 - pct*280) + "px";
    // Background brighten
    dive.style.background = "radial-gradient(80% 60% at 50% 0%, var(--sea1) 0%, var(--sea2) "+Math.round(40+30*pct)+"%, var(--sea3) 85%)";
    document.getElementById('timerLabel').textContent = fmt(diveSecs);
    if(diveSecs<=0){ stopDive(); document.getElementById('timerLabel').textContent="Surface reached ‚úÖ"; }
  }, 1000);
}
function stopDive(){
  clearInterval(diveInt);
  stopFishLoop(); clearBubbles();
}
function fmt(s){ const m=Math.floor(s/60), ss=("0"+(s%60)).slice(-2); return m+":"+ss; }
function createFishLoop(){
  const layer = document.getElementById('fishLayer');
  fishTimer = setInterval(()=>{
    const fish = document.createElement('div');
    fish.className = 'fish';
    const y = 40 + Math.random()*260;
    fish.style.top = y + "px";
    fish.style.left = "-60px";
    const speed = 2 + Math.random()*3;
    let x = -60;
    const move = ()=>{
      x += speed;
      fish.style.left = x + "px";
      if(x > 520){ fish.remove(); cancelAnimationFrame(anim); return; }
      anim = requestAnimationFrame(move);
    };
    let anim = requestAnimationFrame(move);
    fish.addEventListener('click', ()=>{
      if(!fish.classList.contains('photographed')){
        fish.classList.add('photographed');
        photos++; document.getElementById('photos').textContent = photos;
      }
    });
    layer.appendChild(fish);
  }, 1200);
}
function stopFishLoop(){
  clearInterval(fishTimer);
  document.querySelectorAll('.fish').forEach(f=> f.remove());
}
function createBubbles(){
  const cont = document.getElementById('bubbles');
  cont.innerHTML='';
  for(let i=0;i<12;i++){
    const b = document.createElement('div'); b.className='bubble';
    b.style.left = Math.round(Math.random()*440) + "px";
    b.style.animationDuration = (5+Math.random()*4) + "s";
    b.style.animationDelay = (Math.random()*3) + "s";
    cont.appendChild(b);
  }
}
function clearBubbles(){ document.getElementById('bubbles').innerHTML=''; }

/* Bubble Burst */
let popInt=null, bubbleScore=0;
function startBubbles(){
  stopBubbles(); bubbleScore=0; document.getElementById('bubbleScore').textContent=bubbleScore;
  const sea = document.getElementById('popsea');
  popInt = setInterval(()=>{
    const b = document.createElement('div');
    b.className='pop';
    b.style.left = Math.round(Math.random()*440) + "px";
    b.style.animationDuration = (5+Math.random()*5)+"s";
    b.addEventListener('click', ()=>{ bubbleScore++; document.getElementById('bubbleScore').textContent=bubbleScore; b.remove(); });
    sea.appendChild(b);
    setTimeout(()=> b.remove(), 11000);
  }, 600);
}
function stopBubbles(){ clearInterval(popInt); document.getElementById('popsea').innerHTML=''; }

/* Name 3 Fish */
const fishNames = ["Clownfish","Parrotfish","Butterflyfish","Angelfish","Grouper","Surgeonfish","Wrasse","Moorish Idol"];
let picked = 0;
function setupNameChips(){
  const box = document.getElementById('fishChips');
  box.innerHTML='';
  picked=0; document.getElementById('nameStatus').textContent = "0 / 3";
  const correct = new Set(["Clownfish","Parrotfish","Butterflyfish","Angelfish"]);
  for(const n of fishNames){
    const chip = document.createElement('div'); chip.className='chip'; chip.textContent=n;
    chip.addEventListener('click', ()=>{
      if(chip.classList.contains('correct') || chip.classList.contains('wrong')) return;
      if(correct.has(n)){ chip.classList.add('correct'); picked++; }
      else{ chip.classList.add('wrong'); }
      document.getElementById('nameStatus').textContent = picked + " / 3";
    });
    box.appendChild(chip);
  }
}

/* Quiz */
const quiz = {
  q: "At what depth is a 3-minute safety stop usually performed?",
  opts: [
    {t:"3 m (10 ft)", good:true},
    {t:"6 m (20 ft)", good:false},
    {t:"9 m (30 ft)", good:false}
  ]
};
function setupQuiz(){
  document.getElementById('quizQ').textContent = quiz.q;
  const box = document.getElementById('quizOpts'); box.innerHTML='';
  quiz.opts.forEach(o=>{
    const el = document.createElement('div'); el.className='opt'; el.textContent=o.t;
    el.addEventListener('click', ()=>{
      if(o.good){ el.classList.add('good'); document.getElementById('quizMsg').textContent="Correct ‚úÖ"; }
      else { el.classList.add('bad'); document.getElementById('quizMsg').textContent="Hint: recreational stop is shallower."; }
    });
    box.appendChild(el);
  });
}

/* Hidden Marine Life */
function setupHidden(){
  const scene = document.getElementById('scene'); scene.innerHTML='';
  const rocks = [
    {w:160,h:90,x:20,y:120},{w:120,h:70,x:220,y:140},{w:100,h:60,x:340,y:100}
  ];
  rocks.forEach(r=>{
    const el=document.createElement('div'); el.className='rock';
    el.style.width=r.w+'px'; el.style.height=r.h+'px'; el.style.left=r.x+'px'; el.style.top=r.y+'px';
    scene.appendChild(el);
  });
  const hides = [
    {x:60,y:150,r:18},{x:270,y:160,r:16},{x:380,y:120,r:14}
  ];
  let found=0; document.getElementById('foundCount').textContent = found+" / "+hides.length;
  hides.forEach(h=>{
    const c=document.createElement('div'); c.className='camouflage'; c.style.width=c.style.height=(h.r*2)+'px';
    c.style.left=(h.x-h.r)+'px'; c.style.top=(h.y-h.r)+'px';
    c.addEventListener('click', ()=>{
      if(!c.classList.contains('found')){
        c.classList.add('found'); found++; document.getElementById('foundCount').textContent = found+" / "+hides.length;
      }
    });
    scene.appendChild(c);
  });
}
setupNameChips(); setupQuiz(); setupHidden();

/* --- Text calorie estimation (simple) --- */
const FOOD_DB = {
  "egg": {"kcal":78,"protein":6,"carbs":0.6,"fat":5},
  "eggs": {"kcal":78,"protein":6,"carbs":0.6,"fat":5},
  "toast": {"kcal":75,"protein":3,"carbs":13,"fat":1},
  "bread": {"kcal":75,"protein":3,"carbs":13,"fat":1},
  "avocado": {"kcal":160,"protein":2,"carbs":8.5,"fat":14.7},
  "banana": {"kcal":105,"protein":1.3,"carbs":27,"fat":0.4},
  "rice": {"kcal":206,"protein":4.3,"carbs":45,"fat":0.4},
  "chicken": {"kcal":165,"protein":31,"carbs":0,"fat":3.6},
  "salmon": {"kcal":208,"protein":20,"carbs":0,"fat":13},
  "yogurt": {"kcal":150,"protein":15,"carbs":6,"fat":4},
  "oats": {"kcal":150,"protein":5,"carbs":27,"fat":3},
  "apple": {"kcal":95,"protein":0.5,"carbs":25,"fat":0.3},
  "olive oil": {"kcal":119,"protein":0,"carbs":0,"fat":13.5},
  "cheese": {"kcal":113,"protein":7,"carbs":1,"fat":9},
  "protein powder": {"kcal":120,"protein":24,"carbs":3,"fat":1.5},
  "milk": {"kcal":103,"protein":8,"carbs":12,"fat":2.4},
  "green smoothie": {"kcal":230,"protein":5,"carbs":45,"fat":3},
  "salmon bowl": {"kcal":520,"protein":35,"carbs":45,"fat":20}
};
function parseQty(token){
  const m = token.match(/^(\d+(?:\.\d+)?)(g|gram|grams|cup|cups|tbsp|tsp|slice|slices)?$/i);
  if(!m) return {n:1, unit:'unit'};
  let n = parseFloat(m[1]); let u = (m[2]||'unit').toLowerCase();
  if(u==='gram'||u==='grams') u='g';
  if(u==='slices') u='slice';
  return {n, unit:u};
}
function estimateMeal(){
  const text = (document.getElementById('meal-text').value||'').toLowerCase();
  if(!text){ document.getElementById('est-out').textContent = 'Type something like "2 eggs, toast, avocado".'; return; }
  const items = text.split(/[,+]/).map(s=> s.trim()).filter(Boolean);
  let total = {kcal:0, protein:0, carbs:0, fat:0}; let parts=[];
  for(const raw of items){
    const bits = raw.split(/\s+/);
    let qty = parseQty(bits[0]);
    let name = bits.slice(qty.unit==='unit' && !/^\d/.test(bits[0]) ? 0 : 1).join(' ').trim();
    if(!name) name = bits[bits.length-1];
    let key = name;
    if(!(key in FOOD_DB) && raw in FOOD_DB){ key = raw; qty={n:1,unit:'unit'}; }
    if(!(key in FOOD_DB)){ const singular = key.replace(/s\b/,''); if(singular in FOOD_DB) key=singular; }
    if(!(key in FOOD_DB)){ parts.push(`${raw}: ?`); continue; }
    const base = FOOD_DB[key];
    let factor = qty.n;
    if(qty.unit==='g'){ factor = qty.n/100; }
    else if(qty.unit==='cup'){ factor = qty.n; }
    else if(qty.unit==='tbsp'){ factor = qty.n; }
    else if(qty.unit==='slice'){ factor = qty.n; }
    total.kcal += base.kcal * factor;
    total.protein += (base.protein||0) * factor;
    total.carbs += (base.carbs||0) * factor;
    total.fat += (base.fat||0) * factor;
    parts.push(`${raw}: ~${Math.round(base.kcal*factor)} kcal`);
  }
  const out = `‚âà ${Math.round(total.kcal)} kcal ¬∑ P ${Math.round(total.protein)} g ¬∑ C ${Math.round(total.carbs)} g ¬∑ F ${Math.round(total.fat)} g | ${parts.join(' ‚Ä¢ ')}`;
  document.getElementById('est-out').textContent = out;
  document.getElementById('meal-cal').value = Math.round(total.kcal);
  document.getElementById('meal-pro').value = Math.round(total.protein);
}
</script>
</body>
</html>
